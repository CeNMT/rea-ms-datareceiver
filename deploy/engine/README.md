# Terraform Engine

Status: ALPHA

Terraform Engine is a framework to jump start your organization onto GCP.
It is a Terraform module generator that puts together Terraform resources and
modules into deployments complete with values for your infrastructure.

## Why?

Users hosting any type of sensitive data on GCP typically need to go through a
few common and repetitive processes such as setting up devops, auditing and
monitoring. By using our out of the box complete end-to-end configs that
implement these steps for you, you can quickly setup a secure and compliant
environment and focus on the parts of the infrastructure that drive your
business.

This tool will help you follow Terraform
[best practices](https://www.hashicorp.com/resources/evolving-infrastructure-terraform-opencredo),
by using the popular open source tool
[Terragrunt](https://terragrunt.gruntwork.io/)
to define smaller modular configs rather than monolithic modules that quickly
get out of hand or need a custom pipeline to manage.

Our templates use Google's best practice modules from the
[Cloud Foundation Toolkit](https://cloud.google.com/foundation-toolkit).

Use our [sample](./samples) configs to quickly get started.

## Requirements

- [Terraform 0.12+](https://www.terraform.io/downloads.html)
- [Terragrunt](https://github.com/gruntwork-io/terragrunt/releases)
- [Go](https://golang.org/dl/)
- [Bazel](https://bazel.build/)

## Usage

The engine takes a path to an input config and a path to output the generated
Terraform configs. After the output has been generated, there is no dependency
on the engine any longer, and the user can directly use the `terraform` and
`terragrunt` binaries to deploy the infrastructure.

Replace the values in [samples/simple.yaml](./samples/simple.yaml) with values
for your infrastructure, then run the following commands:

```
# Step 1: Clone repo
$ git clone https://github.com/GoogleCloudPlatform/healthcare
$ cd healthcare/deploy/engine

# Step 2: Setup helper env vars
$ ENGINE_ROOT=$PWD
$ CONFIG_PATH=$PWD/samples/simple.yaml
$ OUTPUT_PATH=/tmp/engine

# Step 3: Generate Terraform configs.
# Edit config with values of your infra.
$ nano $CONFIG_PATH
$ bazel run :main -- --config_path=$CONFIG_PATH --output_path=$OUTPUT_PATH

# Step 4: Run one time bootstrap to setup devops project to host Terraform state.
$ cd $OUTPUT_PATH/bootstrap
$ terraform init
$ terraform plan
$ terraform apply

# Step 5 (Optional): Backup bootstrap state to GCS backend.
$ sed -i 's/ENABLE_BOOTSTRAP_GCS_BACKEND: false/ENABLE_BOOTSTRAP_GCS_BACKEND: true/' $CONFIG_PATH
# Regenerate Terraform configs with bootstrap backend added.
$ cd $ENGINE_ROOT
$ bazel run :main -- --config_path=$CONFIG_PATH --output_path=$OUTPUT_PATH
$ cd $OUTPUT_PATH/bootstrap
$ terraform init

# Step 6: Deploy org infrastructure.
$ cd $OUTPUT_PATH/org
$ terragrunt init-all
$ terragrunt plan-all
$ terragrunt apply-all

# Step 7 (Optional): Modify and/or add deployments as needed...
$ cd $OUTPUT_PATH/org/.../example-deployment
$ terragrunt init
$ terragrunt plan
$ terragrunt apply
```

## Tips

- Before running `terragrunt apply-all` always run `terragrunt plan-all` and
  carefully review the output. Look for the values of the known fields to ensure
  they are what you expect. You may see some values with the word "mock" in
  them. These values are coming from other deployments and will be filled with
  the real value once Terragrunt runs the dependent deployment.

- `terragrunt apply-all` should be used at least once to deploy your baseline
  org. After that, individual deployments should only be deployed one at a time
  using `terragrunt apply`. This reduces the chances of a bad apply affecting
  multiple parts of your infra and reduces the permissions needed.

- If you plan on using the engine again, do not manually modify any generated
  file as it will be overwritten the next time the engine runs. Instead, prefer
  to change the input config, recipe or component for the generated files and
  add new resources under new deployments that are not generated by the engine.

- Always backup any engine configs as well as the generated Terraform configs
  and any modifications to the Terraform configs to version control.
